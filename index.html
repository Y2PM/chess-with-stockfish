<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chess with Stockfish</title>
  <!-- Chessboard.js CSS via unpkg -->
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
  <style>
    body { font-family: sans-serif; text-align: center; }
    #board { width: 400px; margin: 20px auto; }
    #controls { margin: 20px; }
  </style>
</head>
<body>
  <h1>Chess with Stockfish</h1>
  <div id="controls">
    <label for="difficulty">Difficulty:</label>
    <select id="difficulty">
      <option value="5">Easy</option>
      <option value="10" selected>Medium</option>
      <option value="15">Hard</option>
    </select>
    &nbsp;&nbsp;
    <label for="color">Play as:</label>
    <select id="color">
      <option value="white" selected>White</option>
      <option value="black">Black</option>
    </select>
    &nbsp;&nbsp;
    <button id="startBtn">Start Game</button>
  </div>
  <div id="board"></div>

  <!-- jQuery (required by Chessboard.js) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Chess.js for game logic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <!-- Chessboard.js for board visuals via unpkg -->
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  
  <!-- Load Stockfish.js via a blob workaround to bypass cross-origin restrictions -->
  <script>
    var stockfish; // Global variable for our worker

    function loadStockfishWorker(url, callback) {
      fetch(url)
        .then(response => response.text())
        .then(text => {
          const blob = new Blob([text], { type: 'application/javascript' });
          const blobURL = URL.createObjectURL(blob);
          callback(new Worker(blobURL));
        })
        .catch(err => {
          console.error("Error loading Stockfish worker:", err);
        });
    }

    // Load Stockfish.js from jsDelivr
    loadStockfishWorker("https://cdn.jsdelivr.net/gh/niklasf/stockfish.js/stockfish.js", function(worker) {
      stockfish = worker;
    });
  </script>
  
  <script>
    var board = null;
    var game = new Chess();
    var playerColor = 'white';
    var difficulty = 10; // Default search depth for Stockfish

    // Called when a piece is dropped on the board.
    function onDrop(source, target) {
      var move = game.move({
        from: source,
        to: target,
        promotion: 'q' // Always promote to queen.
      });
      if (move === null) return 'snapback';
      // After player's move, let Stockfish respond.
      window.setTimeout(makeBestMove, 250);
    }

    // Request and execute Stockfish's best move.
    function makeBestMove() {
      if (!stockfish) {
        console.error("Stockfish worker not loaded yet.");
        return;
      }
      stockfish.postMessage("position fen " + game.fen());
      stockfish.postMessage("go depth " + difficulty);

      stockfish.onmessage = function(event) {
        var line = event.data;
        if (line.indexOf("bestmove") !== -1) {
          var bestMove = line.split(" ")[1];
          game.move(bestMove, {sloppy: true});
          board.position(game.fen());
        }
      };
    }

    // Start or reset the game when "Start Game" is clicked.
    document.getElementById('startBtn').addEventListener('click', function() {
      difficulty = parseInt(document.getElementById('difficulty').value);
      playerColor = document.getElementById('color').value;
      game.reset();
      board = Chessboard('board', {
        position: 'start',
        orientation: playerColor,
        draggable: true,
        onDrop: onDrop,
        // Use external piece images hosted on chessboardjs.com
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
      });
    });
  </script>
</body>
</html>
