<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chess with Stockfish</title>
  <!-- Chessboard.js CSS via unpkg v3 -->
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    /* Dark mode styles */
    .dark-mode {
      background-color: #222;
      color: #ddd;
    }
    #controls {
      margin-bottom: 10px;
    }
    /* Captured pieces containers */
    #capturedTop, #capturedBottom {
      margin: 10px auto;
      width: 400px;
      min-height: 40px;
    }
    /* Board wrapper with fixed size */
    #boardWrapper {
      display: inline-block;
      position: relative;
      width: 400px;
      height: 400px;
      margin: 20px;
    }
    /* File (letters) notation styling */
    #fileNotation {
      position: absolute;
      bottom: -22px;
      left: 0;
      width: 100%;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    /* Rank (numbers) notation styling using flex for even spacing */
    #rankNotation {
      position: absolute;
      top: 0;
      left: -22px;
      height: 100%;
      display: none;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #rankNotation div {
      height: 50px; /* 400px / 8 squares */
      line-height: 50px;
    }
  </style>
</head>
<body>
  <h1>Chess with Stockfish</h1>
  <div id="controls">
    <label for="difficulty">Difficulty:</label>
    <select id="difficulty">
      <option value="5">Easy</option>
      <option value="10" selected>Medium</option>
      <option value="15">Hard</option>
    </select>
    &nbsp;&nbsp;
    <label for="color">Play as:</label>
    <select id="color">
      <option value="white" selected>White</option>
      <option value="black">Black</option>
    </select>
    &nbsp;&nbsp;
    <button id="startBtn">Start Game</button>
    &nbsp;&nbsp;
    <label for="darkToggle">Dark Mode:</label>
    <input type="checkbox" id="darkToggle">
  </div>
  <!-- Captured pieces containers -->
  <div id="capturedTop"></div>
  <!-- Board wrapper with external coordinate notation -->
  <div id="boardWrapper">
    <div id="board" style="width: 100%; height: 100%;"></div>
    <div id="fileNotation">a b c d e f g h</div>
    <div id="rankNotation">
      <div>8</div>
      <div>7</div>
      <div>6</div>
      <div>5</div>
      <div>4</div>
      <div>3</div>
      <div>2</div>
      <div>1</div>
    </div>
  </div>
  <div id="capturedBottom"></div>

  <!-- jQuery (required by Chessboard.js) -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Chess.js for game logic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <!-- Chessboard.js for board visuals via unpkg -->
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  
  <!-- Load Stockfish.js via a blob workaround to bypass cross-origin restrictions -->
  <script>
    var stockfish; // Global Stockfish worker

    function loadStockfishWorker(url, callback) {
      fetch(url)
        .then(response => response.text())
        .then(text => {
          const blob = new Blob([text], { type: 'application/javascript' });
          const blobURL = URL.createObjectURL(blob);
          callback(new Worker(blobURL));
        })
        .catch(err => {
          console.error("Error loading Stockfish worker:", err);
        });
    }
    // Load Stockfish.js from jsDelivr
    loadStockfishWorker("https://cdn.jsdelivr.net/gh/niklasf/stockfish.js/stockfish.js", function(worker) {
      stockfish = worker;
    });
  </script>
  
  <script>
    var board = null;
    var game = new Chess();
    var playerColor = 'white';
    var difficulty = 10; // Default search depth for Stockfish
    // Captured pieces containers will be set on game start.
    var capturedTopContainer, capturedBottomContainer;

    // Initialize an empty board (using an empty FEN for no pieces)
    board = Chessboard('board', {
      position: "8/8/8/8/8/8/8/8",
      draggable: false,
      showNotation: false,
      pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    });

    // Dark mode toggle handler
    document.getElementById('darkToggle').addEventListener('change', function() {
      if(this.checked) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    });

    // Shared function to update captured pieces based on a move
    function updateCaptured(move) {
      var capturedPieceCode;
      // Determine captured piece image code based on move color.
      if(move.color === 'w') {
        capturedPieceCode = 'b' + move.captured.toUpperCase();
        if(playerColor === 'white') {
          capturedBottomContainer.innerHTML += '<img src="https://chessboardjs.com/img/chesspieces/wikipedia/' + capturedPieceCode + '.png" style="height:30px; margin:2px;">';
        } else {
          capturedTopContainer.innerHTML += '<img src="https://chessboardjs.com/img/chesspieces/wikipedia/' + capturedPieceCode + '.png" style="height:30px; margin:2px;">';
        }
      } else if(move.color === 'b') {
        capturedPieceCode = 'w' + move.captured.toUpperCase();
        if(playerColor === 'black') {
          capturedBottomContainer.innerHTML += '<img src="https://chessboardjs.com/img/chesspieces/wikipedia/' + capturedPieceCode + '.png" style="height:30px; margin:2px;">';
        } else {
          capturedTopContainer.innerHTML += '<img src="https://chessboardjs.com/img/chesspieces/wikipedia/' + capturedPieceCode + '.png" style="height:30px; margin:2px;">';
        }
      }
    }

    // Called when a piece is dropped on the board (human move).
    function onDrop(source, target) {
      var move = game.move({
        from: source,
        to: target,
        promotion: 'q' // Always promote to queen.
      });
      if (move === null) return 'snapback';
      
      if(move.captured) { updateCaptured(move); }
      
      // After player's move, let Stockfish respond.
      window.setTimeout(makeBestMove, 250);
    }

    // Request and execute Stockfish's best move.
    function makeBestMove() {
      if (!stockfish) {
        console.error("Stockfish worker not loaded yet.");
        return;
      }
      stockfish.postMessage("position fen " + game.fen());
      stockfish.postMessage("go depth " + difficulty);
      
      stockfish.onmessage = function(event) {
        var line = event.data;
        if (line.indexOf("bestmove") !== -1) {
          var bestMove = line.split(" ")[1];
          var move = game.move(bestMove, {sloppy: true});
          board.position(game.fen());
          if(move && move.captured) { updateCaptured(move); }
        }
      };
    }

    // Start or reset the game when "Start Game" is clicked.
    document.getElementById('startBtn').addEventListener('click', function() {
      difficulty = parseInt(document.getElementById('difficulty').value);
      playerColor = document.getElementById('color').value;
      game.reset();
      // Reset captured pieces containers
      document.getElementById('capturedTop').innerHTML = "";
      document.getElementById('capturedBottom').innerHTML = "";
      // Assign captured pieces containers based on player's side.
      if(playerColor === 'white') {
        capturedBottomContainer = document.getElementById('capturedBottom'); // player's captures (black pieces)
        capturedTopContainer = document.getElementById('capturedTop');         // opponent's captures (white pieces)
      } else {
        capturedBottomContainer = document.getElementById('capturedBottom'); // player's captures (white pieces)
        capturedTopContainer = document.getElementById('capturedTop');         // opponent's captures (black pieces)
      }
      // Show external coordinate notation
      document.getElementById('fileNotation').style.display = 'block';
      document.getElementById('rankNotation').style.display = 'flex';
      
      // Reinitialize the board with the starting position.
      board = Chessboard('board', {
        position: 'start',
        orientation: playerColor,
        draggable: true,
        onDrop: onDrop,
        showNotation: false,  // Using our external notation
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
      });
      // If playing as black, let Stockfish (white) move first.
      if(playerColor === 'black') {
        setTimeout(makeBestMove, 250);
      }
    });
  </script>
</body>
</html>
